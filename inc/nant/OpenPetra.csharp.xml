<?xml version="1.0"?>
<project name="OpenPetra-csharp">

<include buildfile="OpenPetra.default.targets.xml"/>

<if test="${file::exists(msbuildtask.file)}">
    <loadtasks assembly="${msbuildtask.file}" unless="${task::exists('msbuild')}"/>
</if>

<target name="MsBuildTarget">
    <msbuild project="${solution.file}" verbosity="Minimal">
        <property name="Configuration" value="${Configuration}"/>
    </msbuild>
</target>

<target name="installNuget">
    <if test="${not file::exists(dir.nuget + '/nuget.exe')}">
      <mkdir dir="${dir.nuget}" failonerror="false"/>
      <exec program="curl" workingdir="${dir.nuget}" resultproperty="rc"> 
        <arg value="--location" />
        <arg value="https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" />
        <arg value="--output" />
        <arg value="${dir.nuget}/nuget.exe" />
      </exec>
    </if>
    <loadtasks assembly="${Ict.Tools.NAntTasks.DLL}" unless="${task::exists('ExecDotNet')}"/> 
    <ExecDotNet program="${dir.nuget}/nuget.exe"
        commandline="install ${dir.3rdParty}/packages.config -OutputDirectory ${dir.nuget}"/>
</target>

<target name="uncrustify" depends="indent" 
        description="indent the code, so it adheres the formatting guidelines" />

<target name="indent" depends="" description="indent the code, so it adheres the formatting guidelines. Use nant -D:files=filename indent">
  <if test="${not property::exists('files')}">
  <!-- set all files as default -->
    <property name="files" value="" />
    <foreach item="File" property="filename" trim="Both">
      <in><items><include name="**.cs" /></items></in>
      <do><property name="files" value="${files},&quot;${filename}&quot;" /></do>
    </foreach>
  </if>
  <property name="files" value="${string::trim(files)}" />
  <echo level="Debug">files='${files}'</echo>
  <foreach item="String" in="${files}" delim="," trim="Both" property="filename"><do>
    <if test="${0!=string::get-length(filename)}">
      <if test="${not OP::IsAutoGeneratedFile(filename)}">
        <echo message="Indent ${filename}"/>
        <exec program="${external.Uncrustify}" workingdir="${project::get-base-directory()}" resultproperty="rc"> 
          <arg value="-q" />
          <arg value="-c" />
          <arg value="${dir.incdir.cfg}/uncrustify-petra.cfg" />
          <arg value="--no-backup" />
          <arg value="${filename}" />
        </exec>
      </if>
    </if>
  </do></foreach>
</target>

<if test="${not target::exists('custclean')}">
  <include buildfile="OpenPetra.target-custclean.xml"/>
</if>

<target name="clean" depends="custclean"/>

<if test="${not target::exists('custdepend')}">
  <include buildfile="OpenPetra.target-custdepend.xml"/>
</if>

<target name="compile" depends="custdepend"/>

</project>
